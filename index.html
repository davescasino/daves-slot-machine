<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dave's Slot Machine</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Chivo+Mono:wght@700&display=swap');
        
        body {
            font-family: 'Chivo Mono', monospace;
            background-color: #1a1a1a;
            color: #f0f0f0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 1rem; 
        }
        
        .slot-container {
            max-width: 600px; /* Widened for 5 reels */
            width: 100%;
            background-color: #2c2c2c;
            border: 8px solid #ffd700;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.3), 0 0 40px rgba(0, 0, 0, 0.5);
            padding: 1.5rem; 
            border-radius: 1.5rem;
        }

        .reel {
            font-size: 3rem; /* Slightly smaller to fit 5 across */
            line-height: 1;
            padding: 1rem 0.2rem;
            text-align: center;
            user-select: none;
            flex: 1;
        }
        
        @keyframes spinning {
            0% { transform: translateY(0); }
            100% { transform: translateY(-20%); }
        }

        .reel.spinning {
            animation: spinning 0.1s linear infinite;
        }

        .button-spin {
            background: linear-gradient(180deg, #ff416c 0%, #ff4b2b 100%);
            transition: all 0.2s ease-in-out;
            box-shadow: 0 4px 0 #c70039;
        }

        .button-spin:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 0 #c70039;
        }
        
        .button-spin:active:not(:disabled) {
            transform: translateY(2px);
            box-shadow: 0 2px 0 #c70039;
        }

        .message-win { color: #10b981; font-weight: 700; }
        .message-jackpot {
            color: #ffd700;
            text-shadow: 0 0 10px #ffd700;
            animation: pulse 0.8s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
    </style>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        let balance = 1000;
        let betAmount = 10;
        let isSpinning = false;
        let highScore = 0;

        // UPDATED: Added 'üíÄ' (Loss symbol) to dilute the pool and worsen odds
        const SYMBOLS = ['üçí', 'üçã', 'üí∞', '7Ô∏è‚É£', 'üíÄ', 'üíÄ', 'üíÄ']; 
        
        // DOM Elements
        let reelElements, balanceDisplay, betInput, spinButton, restartButton, messageDisplay, highScoreDisplay;
        let db, auth, userId = 'anon_user';

        async function initGame() {
            reelElements = [
                document.getElementById('reel1'), document.getElementById('reel2'),
                document.getElementById('reel3'), document.getElementById('reel4'),
                document.getElementById('reel5')
            ];
            balanceDisplay = document.getElementById('balance');
            betInput = document.getElementById('betAmount');
            spinButton = document.getElementById('spinButton');
            restartButton = document.getElementById('restartButton');
            messageDisplay = document.getElementById('message');
            highScoreDisplay = document.getElementById('highScoreDisplay');

            // Firebase placeholder logic (simplified for brevity)
            try {
                const app = initializeApp(JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}'));
                db = getFirestore(app);
                auth = getAuth(app);
                signInAnonymously(auth);
                onAuthStateChanged(auth, (user) => { if(user) userId = user.uid; setupHighscoreListener(); });
            } catch (e) { console.error(e); }

            renderGame();
        }

        function setupHighscoreListener() {
            if (!db) return;
            onSnapshot(doc(db, 'highscores', 'global'), (ds) => {
                if (ds.exists()) { highScore = ds.data().score; highScoreDisplay.textContent = `$${highScore.toLocaleString()}`; }
            });
        }
        
        function getRandomSymbol() {
            return SYMBOLS[Math.floor(Math.random() * SYMBOLS.length)];
        }

        /**
         * LOGIC FOR 5 REELS (Worse Odds):
         * - 5 of a kind is the only way to get big payouts.
         * - 4 of a kind gives a moderate return.
         * - 3 of a kind barely breaks even.
         * - üíÄ Symbols never pay out.
         */
        function checkWin(reels) {
            const counts = {};
            reels.forEach(s => counts[s] = (counts[s] || 0) + 1);

            // Remove the death symbol from winning considerations
            delete counts['üíÄ'];

            for (let s in counts) {
                if (counts[s] === 5) {
                    if (s === '7Ô∏è‚É£') return 500; // Super Jackpot
                    if (s === 'üí∞') return 200;
                    return 100; // 5 Cherries/Lemons
                }
                if (counts[s] === 4) return 20; // 4 of a kind
                if (counts[s] === 3) return 2;  // 3 of a kind (Small win)
            }
            return 0;
        }

        async function spin() {
            if (isSpinning || balance < betAmount) return;
            
            isSpinning = true;
            balance -= betAmount;
            messageDisplay.textContent = "Good luck...";
            messageDisplay.className = "text-center h-10 mt-4 text-lg font-bold text-gray-400";
            renderGame();

            reelElements.forEach(reel => reel.classList.add('spinning'));

            await new Promise(r => setTimeout(r, 1200));

            const finalReels = [];
            for (let i = 0; i < 5; i++) {
                reelElements[i].classList.remove('spinning');
                const symbol = getRandomSymbol();
                reelElements[i].textContent = symbol;
                finalReels.push(symbol);
                await new Promise(r => setTimeout(r, 200));
            }
            
            const multiplier = checkWin(finalReels);
            const winnings = multiplier * betAmount;
            balance += winnings;

            if (multiplier >= 100) {
                messageDisplay.className = 'message-jackpot text-3xl mt-4';
                messageDisplay.textContent = `MEGA WIN! $${winnings}! üé∞`;
            } else if (winnings > 0) {
                messageDisplay.className = 'message-win text-2xl mt-4';
                messageDisplay.textContent = `Won $${winnings}`;
            } else {
                messageDisplay.className = 'text-red-500 mt-4';
                messageDisplay.textContent = "Nothing. Spin again?";
            }

            if (balance <= 0) {
                spinButton.classList.add('hidden');
                restartButton.classList.remove('hidden');
            }

            isSpinning = false;
            renderGame();
        }

        function renderGame() {
            balanceDisplay.textContent = `$${balance.toLocaleString()}`;
            spinButton.disabled = isSpinning || balance < betAmount;
            betInput.disabled = isSpinning;
        }

        window.onload = initGame;
        window.spin = spin;
        window.restartGame = () => location.reload();
        window.updateBet = () => {
            let val = parseInt(document.getElementById('betAmount').value);
            if (val > 0 && val <= balance) betAmount = val;
        };
    </script>
</head>
<body>
    <div class="slot-container m-4">
        <h1 class="text-3xl font-bold text-center mb-4 text-yellow-500">DAVE'S 5-REEL PIT</h1>

        <div class="flex justify-between items-center mb-6 p-3 bg-gray-800 rounded-lg border-b-4 border-red-600">
            <div class="flex-1">
                <span class="text-xs uppercase text-gray-500">Bankroll</span>
                <div id="balance" class="text-xl font-bold text-white">$1000</div>
            </div>
            <div class="text-center flex-1">
                <span class="text-xs uppercase text-gray-500">Record</span>
                <div id="highScoreDisplay" class="text-xl font-bold text-emerald-500">$0</div>
            </div>
            <div class="text-right">
                <input type="number" id="betAmount" value="10" onchange="updateBet()" class="w-16 bg-black border border-gray-600 text-yellow-500 text-center rounded">
            </div>
        </div>

        <div class="flex justify-between bg-black rounded-lg p-2 mb-6 border-2 border-gray-700 shadow-inner">
            <div id="reel1" class="reel">üíÄ</div>
            <div id="reel2" class="reel">üíÄ</div>
            <div id="reel3" class="reel">üíÄ</div>
            <div id="reel4" class="reel">üíÄ</div>
            <div id="reel5" class="reel">üíÄ</div>
        </div>

        <button id="spinButton" onclick="spin()" class="button-spin w-full text-white font-bold text-2xl py-4 rounded-xl uppercase">SPIN</button>
        <button id="restartButton" onclick="restartGame()" class="button-spin w-full text-white font-bold text-2xl py-4 rounded-xl uppercase hidden">BUSTED? RESTART</button>
        
        <div id="message" class="text-center h-10 mt-4 text-lg font-bold">Try your luck... if you dare.</div>

        <div class="mt-6 text-[10px] text-gray-500 border-t border-gray-800 pt-4">
            <p class="text-center mb-2 text-red-800 font-bold">TOUGH LUCK PAYOUTS</p>
            <div class="grid grid-cols-2 gap-2">
                <span>5 x 7Ô∏è‚É£: 500x</span>
                <span>4 x Any: 20x</span>
                <span>5 x üí∞: 200x</span>
                <span>3 x Any: 2x</span>
                <span>5 x Fruit: 100x</span>
                <span class="text-red-400">üíÄ: PAYS $0</span>
            </div>
        </div>
    </div>
</body>
</html>
